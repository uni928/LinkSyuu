<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>uni928 のリンク集</title>
  <style>
    :root {
      --bg:#0f172a;            /* slate-900 */
      --card:#111827;          /* gray-900 */
      --text:#e5e7eb;          /* gray-200 */
      --muted:#9ca3af;         /* gray-400 */
      --accent:#22d3ee;        /* cyan-400 */
      --ok:#10b981;            /* emerald-500 */
      --warn:#f59e0b;          /* amber-500 */
      --err:#ef4444;           /* red-500 */
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #0b1224, transparent), var(--bg);
      color:var(--text);
    }
    header{ padding:24px; max-width:1200px; margin:0 auto; }
    h1{font-size: clamp(22px, 3vw, 32px); margin:0 0 6px}
    .desc{color:var(--muted); line-height:1.7}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; margin-top:12px}
    button{ background: linear-gradient(180deg, rgba(34,211,238,.25), rgba(34,211,238,.05));
      color:var(--text); border:1px solid rgba(34,211,238,.4); padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow: 0 6px 24px rgba(34,211,238,.08) inset, 0 4px 18px rgba(0,0,0,.35);
    }
    button:hover{filter:brightness(1.08)}
    main{max-width:1200px; margin:0 auto; padding:8px 16px 48px}

    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06);
      padding:16px; border-radius:16px; position:relative; min-height:116px; }
    .title{ font-weight:700; font-size:18px; margin-bottom:6px }
    .url{ font-size:12px; color:var(--muted); word-break: break-all }
    .meta{ font-size:12px; color:var(--muted); margin-top:10px; display:flex; gap:10px; flex-wrap:wrap }
    .badges{ position:absolute; right:10px; top:10px; display:flex; gap:6px; }
    .badge{ font-size:11px; font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); }
    .b-new{ color:#002; background: linear-gradient(180deg, rgba(34,211,238,.8), rgba(34,211,238,.35)); border-color: rgba(34,211,238,.7) }
    .b-upd{ color:#140900; background: linear-gradient(180deg, rgba(245,158,11,.9), rgba(245,158,11,.45)); border-color: rgba(245,158,11,.8) }
    .b-ok{  color:#00140b; background: linear-gradient(180deg, rgba(16,185,129,.8), rgba(16,185,129,.4)); border-color: rgba(16,185,129,.8) }
    .b-unk{ color:#160000; background: linear-gradient(180deg, rgba(239,68,68,.85), rgba(239,68,68,.45)); border-color: rgba(239,68,68,.8) }
    .b-weak{ color:#001016; background: linear-gradient(180deg, rgba(59,130,246,.85), rgba(59,130,246,.45)); border-color: rgba(59,130,246,.8) }

    .actions{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap }
    .actions a, .actions button{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); font-weight:700;
      border:1px solid rgba(255,255,255,.12); padding:8px 10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); cursor:pointer
    }
    .actions a:hover, .actions button:hover{ filter:brightness(1.08) }
    .note{ font-size:12px; color:var(--muted); margin-top:8px }
    .small{ font-size:11px; color:var(--muted) }

    .settings{ margin-top:16px; display:grid; gap:10px; grid-template-columns: minmax(240px,1fr) 1fr; align-items:center; }
    .settings input[type="text"], .settings input[type="number"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); color:var(--text) }
    .settings label{ font-size:13px; color:var(--muted) }
    .settings .row{ display:contents }

    footer{ max-width:1200px; margin:0 auto; padding:16px 24px; border-top:1px dashed rgba(255,255,255,.08); color:var(--muted) }
    code.k{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); padding:2px 6px; border-radius:6px }
  </style>
</head>
<body>
  <header>
    <h1>uni928 のリンク集</h1>
    <p class="desc">
      それぞれのサイトについて <b>最終アクセス日時</b> だけを <b>IndexedDB</b> に保存します。<br>一部省略しています。本当の一覧は <a href="https://github.com/uni928?tab=repositories">こちら</a> から調べて下さい。<br>ほとんどのサイトがダウンロードして使用できます。<a href="https://github.com/uni928?tab=repositories">こちら</a> からダウンロードするのが確実ですが、ブラウザの機能でダウンロードしても動作するものもあると思います。<br>安心して利用したい方はダウンロードして、情報を抜く or 怪しいコードがないか ChatGPT に質問してから、使用する事を推奨します。
    </p>

    <div class="toolbar">
      <button id="btn-reset">記録を全て削除</button>
      <span id="diag" class="note" style="margin-left:8px">モード: 最終アクセスのみ（更新チェック無効）</span>
    </div>
  </header>

  <main>
    <section class="grid" id="linkGrid"></section>
  </main>

<script>

//{ name: '', url: '', text: ''},
  
// === 設定：チェーン一覧（追加/編集してください） ================================
const CHAINS = [
  { name: 'シンプルな家計簿のサイト', url: 'https://uni928.github.io/Kakeibo/index5.html', text: '家計簿サイトです。\n\nログイン等が不要で、アクセスするだけで使用できます。'},
  { name: '小説をローカルに保存するためのサイト(自動ではありません)', url: 'https://uni928.github.io/SyousetuReader/index3.html', text: '小説を編集画面で登録する事で、小説をオフラインで見れるようになります。\n\n手動で登録する必要があるため、作業は時間がかかります。\n\nリアルタイムセーブ版はブラウザの記憶領域に微量ながらデータが蓄積されてしまいますが便利です。'},
  { name: '小説をローカルに保存サンプル', url: 'https://uni928.github.io/SyousetuReader/index5.html', text: '小説をローカルに保存するサイトのお試し用です。音声読み上げ機能の快適さを体感して下さい。読み上げ速度は2.0を推奨します。画面オンなどスリープ防止のアプリと併用が必要かもしれません。'},
  { name: '音声読み上げサイト', url: 'https://uni928.github.io/MyTextToSpeech/', text: '音声読み上げ用のサイトです。入力された文章を見やすく読み上げます。\n\n読み上げを中断されたりしない分、読み上げの心地よさは「小説をローカルに保存するためのサイト(自動ではありません)」の方が優れていますが、こちらは入力が多少楽のはずです。'},
  { name: '記憶ボタン付き電卓', url: 'https://uni928.github.io/TestYou/index6.html', text: '使いやすい記憶ボタン機能付きの電卓です。式も記憶できるため、何の数字だったか忘れにくいメリットがあります。'},
  { name: '2 面トランプ作成', url: 'https://uni928.github.io/2MenTranpuCreater/', text: '私個人的に作成した 2 面トランプを作成するためのサイトです。\n\nトランプで日頃遊ぶ人は楽しめると思います。'},
  { name: '励ます言葉を垂れ流すサイト', url: 'https://uni928.github.io/EncouragingSite/', text: '励ましの言葉を垂れ流すサイトです。落ち込んでいる時に聞くと多少気持ちが楽になるかもしれません。'},
  { name: '文字数カウンター Studio', url: 'https://uni928.github.io/StringNumChecker/', text: '文字数をチェックするためのサイトです。'},
  { name: 'X に何文字でも呟ける', url: 'https://uni928.github.io/TestYou/index9.html', text: 'X は URL が 23 文字になります。文章を URL にすることで、X に何文字でも呟けるようになります。BAN されたり SEO 的に弱くなる可能性があります。使用は自己責任でお願いします。'},
  { name: 'X の文章の作成補助', url: 'https://uni928.github.io/XStringCreateHelper/', text: 'X の文章の作成を補助します。Xで直接書くと誤投稿の可能性があり、編集すれば良いだけとはいえ面倒なので、こういったサイトを活用頂こうという趣旨です。'},
  { name: '数字挟み系落ちものパズル', url: 'https://uni928.github.io/FallGamePuzzle/', text: '落ちものパズルです'},
  { name: 'プログラミングのコードを効率的に読む', url: 'https://uni928.github.io/TestYou/index4.html', text: 'コードを宣言部分に飛ぶ機能・飛ぶ前の地点に戻る機能付きのリーダーです。飛んだ先は範囲選択されるため、見やすいです。'},
  { name: 'サイト URL の QR を読み込んでアクセスする', url: 'https://uni928.github.io/ReadQRAndMove/', text: 'サイトの URL が書かれた QR コードを読み込んで、サイトにアクセスします。\n\nこのサイトがあれば QR コードのアプリを入れる必要がなくなるかもしれません。\n\nGoogle レンズを使うのが気にならない人はそちらの方が良いかもしれません。私は苦手なのでこのサイトを使っています。\n\nQRコードはデンソーウェーブの商標です。'},
  { name: '動画に効率的に手動で字幕を付ける補助サイト', url: 'https://uni928.github.io/CreateZimakuHelper/', text: '手動ですが、動画の字幕を付ける補助サイトです。\nSRT ファイルを作成する事で、動画編集ソフト or サイトで字幕を一括で付ける事が出来ます。\n字幕テキストを入れて、開始したい地点で挿入をすると、開始地点が設定された字幕が追加されます。\n字幕をクリックして、終了したい地点で末尾を設定をすると、字幕に終了地点が設定されます。\n字幕を全て入れたら SRT ファイルを出力して、動画編集ソフト or サイトで字幕を付けて完成です。'},
  { name: '飲食店ガチャ', url: 'https://uni928.github.io/TestYou/index5.html', text: '今日の夕食が決まっていない方へ、1000円以内で提案します。'},
  { name: '歯磨き補助', url: 'https://uni928.github.io/TestYou/index7.html', text: '歯磨きの補助サイトです。右奥歯の外側を磨いて下さい（残り12秒）などが表示されます。'},
  { name: 'その定期いくらお得？', url: 'https://uni928.github.io/TestYou/index2.html', text: '〇ヵ月定期が 1 か月定期よりいくらお得か調査するためのサイトです。'},
  { name: 'ツリー構造のメモ帳', url: 'https://uni928.github.io/TreeMemo/index3.html', text: 'ツリー構造のメモサイトです。大項目・中項目・小項目で管理する方は是非'},
  { name: 'ツリー構造のメモ帳簡易版', url: 'https://uni928.github.io/TreeMemo/index4.html', text: 'ツリー構造のメモサイトです。\n\n大項目・中項目・小項目で管理する方は是非。\n\nこちらは簡易版です。\n\nPNGでも出力しておくのが、見た目的に綺麗です。'},
  { name: 'Time Memory Calendar', url: 'https://uni928.github.io/TestYou/index10.html', text: '何かの時間を記憶するサイトです。\n\n勉強時間など時間を記憶したい場合にご利用下さい。'},
  { name: '文字列から数値を取り出して計算', url: 'https://uni928.github.io/TestYou/index12.html', text: '文章の数値部分を抽出して足し合わせます。先頭に-が付く数値は引きます。'},
  { name: 'スマホ間で文字のやりとり', url: 'https://uni928.github.io/MoziSwap/', text: 'スマホ間で文章をやりとりします。スマホ A からスマホ B に文章を渡したい場合は是非ご利用下さい。QR コードはデンソーウェーブの商標です。'},
  { name: '画像を特定のサイズ・場所で切り取るサイト', url: 'https://uni928.github.io/SpecificSizeCutImage/', text: '画像を特定のサイズにカットします。\n\nローカルにダウンロードして使用する事で、守秘義務のある画像も気軽に扱う事ができます。(ChatGPT で情報を抜き取るコードが含まれてないか質問する事で、より安心できます)(守秘義務を無視すれば、ネット上にもっと良いサイトがあります。気にならない方はそちらでも構わないと考えます)\n\n2 倍 or 4 倍に拡大してから切り取る事もできます。切り取りたい範囲より元画像が小さい場合はご利用下さい。\n\n画像を読み込んで、横幅と縦幅をピクセル指定して、何処を切り取るか指定します。\n\nその後「切り取ってダウンロード」ボタンを押すだけで、欲しかった切り取り画像を入手できます。\n\nアイコン作成等にご利用下さい。'},
  { name: '画像にモザイクを効率的にかける', url: 'https://uni928.github.io/PixelMosaicMaker/', text: '画像にモザイクを効率的にかけるためのサイトです。\n\nモザイクをかけるという事は公開したくない情報だと思うので、是非ダウンロードして、ChatGPT で情報を抜きとる処理が含まれていない事を確認してからご利用下さい。'},
  { name: 'スマホフリック操作練習', url: 'https://uni928.github.io/TestYou/index13.html', text: 'スマホのフリック操作練習用のサイトです。'},
  { name: 'テキスト内の \\n を改行に変換', url: 'https://uni928.github.io/TestYou/index15.html', text: '改行記号を改行に変換するためのサイトです。地味にこういったサイトは見つからないため作成しました。'},
  { name: '休憩管理タイマー', url: 'https://uni928.github.io/BreakTimeManagerPC/', text: '休憩時間を管理するためのサイトです。\n\n30分休憩して 5 分休むが自分に合っていない方はこちらをお試し頂くのも良いと思います。'},
  { name: 'ランダムな Base62 の文字列を生成', url: 'https://uni928.github.io/RandomStringGenerator/', text: 'ランダムな Base62 の文字列を生成するためのサイトです。\n\n暗号化キーの生成等にご利用頂ければと思います。'},  
  { name: 'ミニゲーム1', url: 'https://uni928.github.io/MiniGame1/', text: '自作のパズルゲームです。\n\n目標点数を目指します。'},
  { name: 'ミニゲーム2', url: 'https://uni928.github.io/MiniGame1/index2.html', text: '自作のパズルゲームです。\n\n目標点数を目指します。'},
  { name: 'ファイル階層図を作る', url: 'https://uni928.github.io/FileDevelopmentDiagramGeneration/', text: 'ファイル階層図を作ります。\n\nフォルダの納品の際にご利用下さい。'},
  { name: '文章をダウンロードフォルダに保存', url: 'https://uni928.github.io/MemotyouTest/index4.html', text: 'スマホで入力した文章を PC で閲覧したい場合は Downloads フォルダ等にテキストファイルを入れる必要があります。\n\nしかしながら、その方法は意外と思いつきません。\n\nそこで、文章をシンプルにダウンロード出来るサイトを作成しました。\n\n是非このサイトを使って PC で閲覧するためのテキストファイルを出力下さい。'},
  { name: '正規表現入力補助', url: 'https://uni928.github.io/RegularExpressionInputAssistance/', text: '正規表現入力補助サイトです。\n\n^ や * など使用できる書式をボタンで一通り用意しているため、思い出せない時はボタンで入力できます。\n\n書式を暗記していない方は是非ご利用頂ければと思います。'},
  { name: 'フォルダを選択して内容をコピー＆表示', url: 'https://uni928.github.io/DirectoryInFileAllCopy/', text: '特定のフォルダの中のファイル名とファイル内容をコピーします。\n\nChatGPT で質問する場合等に便利です。'},
  { name: '1ファイルをドラッグ＆ドロップ → 関連ファイル名＆内容をコピー', url: 'https://uni928.github.io/DirectoryInFileAllCopy/index4.html', text: '特定のファイルとその関連ファイルのファイル名とファイル内容を一括でコピーします。'},
  { name: 'がっつり 1 週間の献立を考える', url: 'https://uni928.github.io/CreateMenuAI2/', text: '1 週間の献立を効率的に作成するサイトです。\n\n買い物リストが出力できますので、日曜日の買いだめが簡単です。'},
  { name: 'MiniGame4-1', url: 'https://uni928.github.io/MiniGame4/', text: '8 番出口ライクのゲームです。'},
  { name: 'MiniGame4-2 PC専用', url: 'https://uni928.github.io/MiniGame4/index2.html', text: '相手を攻撃して倒すアクションゲームです。\n\n作業の待ち時間の暇つぶしに是非'},
  { name: 'カードゲームの展開をメモ', url: 'https://uni928.github.io/CardGameDevelopmentNotes/', text: 'カードゲームの展開メモ用サイトです。\n\n手札に必要なカード、使用するカード、展開をメモします。'},
  { name: 'ChatGPT のバックアップ', url: 'https://uni928.github.io/ChatGPTSearcher/index3.html', text: 'ChatGPT のチャット履歴をローカルに保存したい方は是非。\n\nhtmlで保存されるため、ブラウザで開くだけで確認できます。'},
  { name: 'ChatGPT の自分の発言のみを抽出して閲覧', url: 'https://uni928.github.io/ChatGPTSearcher/index4.html', text: 'ChatGPT は自分のコメントだけ見る事で、探したい履歴を簡単に探せます。\n\nこのサイトを使って、探したいやり取りを効率的に探してみて下さい。'},
  { name: '自作の検索ページ', url: 'https://uni928.github.io/Kensaku/index2.html', text: 'ミニマリスト専用の検索ページです。\n\n広告等不要な表示は一切ありません。'},
  { name: 'ChatGPT のプロジェクト機能のファイル数上限を回避', url: 'https://uni928.github.io/ChatGPTProjectCompressor/', text: 'ファイル数上限が来た方は是非'},
  { name: '家系図を出力', url: 'https://uni928.github.io/CreateFamilyTree/', text: '家系図を簡単に作成します。'},
  { name: 'ミニゲームその 2', url: 'https://uni928.github.io/MiniGame2/index2.html', text: '足して合計丁度を計測する速度を競います。'},
  { name: 'PC 初心者向けの文字の入力補助', url: 'https://uni928.github.io/PCBeginnerAid/', text: 'PC 初心者は文字入力が苦手な人がいますので、あいうえお表で入力できるサイトです。'},
  { name: 'コピー＆ペースト管理', url: 'https://uni928.github.io/CopyAndPasteManager/', text: 'よくコピーする構文をストックできます。コピーボタンですぐにコピーできます。'},
  { name: 'ブレインストーミングをグループ', url: 'https://uni928.github.io/BresutoAndKJ/', text: 'ブレインストーミングの補助サイトです。'},
  { name: '街 1 番の善人を目指すゲーム', url: 'https://uni928.github.io/MostBecomeGoodPersonGame/', text: 'ストラテジーゲームです。やりくりして街一番の善人を目指しましょう。'},
  { name: 'Google マップ効率化', url: 'https://uni928.github.io/RootNavi/', text: 'Google マップのナビに必要な手順を減らします。'},
  { name: 'PassGenerator', url: 'https://uni928.github.io/PassGenerator/', text: '特定の文字からパスワードを生成します。よく使う 4 桁のパスワードや ID をパスワードに変換してしまいましょう。'},
  { name: 'メモ帳1', url: 'https://uni928.github.io/MemotyouTest/index2.html', text: '効率重視のメモ帳です。'},
  { name: 'メモ帳2', url: 'https://uni928.github.io/MemotyouTest/index3.html', text: '普通のメモ帳です。'},
  { name: 'サイトの表示崩れチェッカー', url: 'https://uni928.github.io/HtmlCollapseTester/', text: 'このチェッカーで調査すれば、表示崩れはないでしょう。'},
  { name: 'RestHelper', url: 'https://uni928.github.io/RestHelper/', text: '休憩中に眺めるためのサイトです。'},
  { name: 'サイトの CSS チェッカー', url: 'https://uni928.github.io/EasyCSSChecker/', text: 'CSS を開発者ツールより見やすくチェックします。'},
  { name: '昨日編集したファイルを調べる', url: 'https://uni928.github.io/OneDateCreateChecker/', text: 'フォルダの編集時間順に並び替えます。'},
  { name: '飲料水のおすすめの確保方法記事', url: 'https://uni928.github.io/DrinkingWaterKizi/', text: '飲料水を安く・手間なしで確保するライフハックの記事です。'},
  { name: 'マインクラフト記事', url: 'https://uni928.github.io/MinecraftKizi/index4.html', text: 'マインクラフトの記事です。\n\n村人との取引のおススメ\nモンスターが怖い場合の対策\nブランチマイニングより村人との取引の方が優れている点\nの紹介を載せています。'},
  { name: '自分の飲料水の飲む量を調査', url: 'https://uni928.github.io/DrinkingWaterManagement/', text: '体調が悪い方、飲む量が足りていないのではないかと思う方、お通じが悪い方は、一度調査しましょう。'},
  { name: 'ライフ計算機', url: 'https://uni928.github.io/LifeClucer/index2.html', text: '遊戯王のライフ計算を効率化します。'},
  { name: 'フォルダの中の拡張子の内訳', url: 'https://uni928.github.io/ShowAllFileAtDirectory/', text: '拡張子の内訳を調査します。csv で記憶できますので、取引先に納品する際に合わせて送信すると良いかもしれません。'},
  { name: 'ChatGPT で生成した html を高速でチェック', url: 'https://uni928.github.io/TestSpeedy/', text: 'ChatGPT で html を作る場合に効率化します。エラーが発生したらChatGPTで修正のプロンプトも出力できます。'},
  { name: 'エクセルのマージ', url: 'https://uni928.github.io/ExcelMarger/', text: '複数のエクセルファイルをマージします。'},
  { name: 'ChatGPT のプロンプト生成', url: 'https://uni928.github.io/SephirothSimplePromptGenerator/', text: 'エラーが発生した場合の ChatGPT のプロンプトを効率的に生成するサイトです。'},
  { name: 'マージ作業を効率化', url: 'https://uni928.github.io/DiffTextEditor/', text: 'マージ作業を効率化します。A,Bのどちらを採用するかを差分毎に指定できます。'},
  { name: '画像を和色などの特定の色のみの構成に変換', url: 'https://uni928.github.io/SephirothImageToSpecificColor/', text: 'この画像は和色のみの構成ならばどのような見た目になるか調べるサイトです。単色のイラストに特に向いています。'},
  { name: 'ハイアンドローゲーム', url: 'https://uni928.github.io/SephirothHighAndLow/', text: '自作のハイアンドローゲームです。出題者が嘘を付ける回数が、3 回回答する度に 1 回増えます。'},
  { name: 'ダミーファイル作成サイト', url: 'https://uni928.github.io/DummyFileCreater/', text: 'ダミーファイルを効率的に作成出来ます。\n\nbat ファイルの中身がコピーされるので、それが中身の bat ファイルを作成下さい。テキストファイルの中身をそれにして、拡張子を bat に変えます。'},
  { name: 'ChatGPT のプロジェクト登録を楽にするサイト', url: 'https://uni928.github.io/ProjectGPT/', text: 'ChatGPT のプロジェクト機能を活用する際に、登録するファイルが色んなフォルダに点在している場合に、bat ファイルと同じ場所に一括で複製して登録作業を楽にするためのサイトです。\n\n要するに便利 bat ファイルを作成するためのサイトです。\n\nプロジェクト機能にファイルを登録する作業が面倒な方は是非ご利用下さい。'},
  { name: 'ミニゲーム5', url: 'https://uni928.github.io/MiniGame5/', text: '部屋を回って 20000G 集めるのにかかった移動数を競うゲームです。\n\n回数が少なければ少ない程良いです。'},
  { name: 'ミニゲーム6', url: 'https://uni928.github.io/TestYou/index8.html', text: '時間内に文字をどれだけ消せるか競うゲームです。操作数を減らすためにある程度纏めて消さないと高得点は狙えません。'},
  { name: 'ダミーテキストギャラリー', url: 'https://uni928.github.io/TestYou/index11.html', text: '用途に応じたダミーテキストを載せています。'},
  { name: '正規表現で文字列を置換', url: 'https://uni928.github.io/RegularExpressionReplacement/', text: '正規表現で文字列を置換します。置換の時に正規表現で置換したい場合は是非'},
];

// === IndexedDB ヘルパー =====================================================
const DB_NAME = 'chain-links-db';
const STORE = 'links';
let db;
const DISABLE_UPDATE_CHECK = true; // 更新チェックを省略（最終アクセスのみ）
let FALLBACK = null; // localStorage ベースのフォールバック

function openDB(){
  return new Promise((resolve)=>{
    try{
      const req = indexedDB.open(DB_NAME, 2);
      req.onupgradeneeded = (e)=>{
        const idb = e.target.result;
        if(!idb.objectStoreNames.contains(STORE)){
          const os = idb.createObjectStore(STORE, { keyPath: 'url' });
          os.createIndex('lastVisited', 'lastVisited');
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror   = ()=> resolve(null); // 失敗時は null を返す
    }catch(err){
      resolve(null);
    }
  });
}


async function getRecord(url){
  if(db){
    try{
      const tx = db.transaction(STORE, 'readonly');
      const os = tx.objectStore(STORE);
      return await new Promise((resolve, reject)=>{
        const r = os.get(url);
        r.onsuccess = ()=> resolve(r.result || null);
        r.onerror   = ()=> reject(r.error);
      });
    }catch(e){/* fallthrough */}
  }
  // フォールバック（localStorage）
  if(FALLBACK==null){
    try{ FALLBACK = JSON.parse(localStorage.getItem('chain-links-fallback')||'{}'); }catch(_){ FALLBACK = {}; }
  }
  return FALLBACK[url] || null;
}

async function putRecord(rec){
  if(db){
    try{
      const tx = db.transaction(STORE, 'readwrite');
      const os = tx.objectStore(STORE);
      return await new Promise((resolve, reject)=>{
        const r = os.put(rec);
        r.onsuccess = ()=> resolve(true);
        r.onerror   = ()=> reject(r.error);
      });
    }catch(e){/* fallthrough */}
  }
  // フォールバック
  if(FALLBACK==null){
    try{ FALLBACK = JSON.parse(localStorage.getItem('chain-links-fallback')||'{}'); }catch(_){ FALLBACK = {}; }
  }
  FALLBACK[rec.url] = rec;
  try{ localStorage.setItem('chain-links-fallback', JSON.stringify(FALLBACK)); }catch(_){ /* quota? ignore */ }
  return true;
}

async function clearAll(){
  if(db){
    try{
      const tx = db.transaction(STORE, 'readwrite');
      const os = tx.objectStore(STORE);
      await new Promise((resolve, reject)=>{
        const r = os.clear();
        r.onsuccess = ()=> resolve(true);
        r.onerror   = ()=> reject(r.error);
      });
    }catch(e){/* ignore */}
  }
  FALLBACK = {};
  try{ localStorage.removeItem('chain-links-fallback'); }catch(_){ }
  return true;
}

// === ユーティリティ ==========================================================
function formatDT(ts){
  if(!ts) return '—';
  const d = new Date(ts);
  const p = (n)=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
}
function badge(text, cls){ const s = document.createElement('span'); s.className = `badge ${cls}`; s.textContent = text; return s; }
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join('');
}

// === UI生成 ================================================================
function cardTemplate(c){
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <div class="badges" data-badges></div>
    <div class="title">${c.name}</div>
    <div class="url">${c.url}</div>
    <div class="actions">
      <a href="${c.url}" target="_blank" rel="noopener" data-open>サイトを開く</a>
      <button data-debug>詳細</button>
    </div>
    <div class="meta">
      <div>最終アクセス: <span data-lastVisited>—</span></div>
    </div>
      <div>最終チェック: <span data-lastChecked>—</span></div>
      <div class="small">ETag: <span data-etag>—</span></div>
      <div class="small">Last-Modified: <span data-lastmod>—</span></div>
      <div class="small">指紋: <span data-fp>—</span></div>
      <div class="small">ソース: <span data-source>—</span></div>
    </div>
  `;
  return div;
}

function setBadges(el, { isNew }){
  const box = el.querySelector('[data-badges]');
  box.innerHTML = '';
  if(isNew) box.appendChild(badge('未訪問', 'b-new'));
  if(!isNew) box.appendChild(badge('訪問済み', 'b-ok'));
}

function computeFlags(rec) {
  // 最終アクセスのみのモード用：未訪問かどうかだけ判定
  const isNew = !rec || !rec.lastVisited;
  return { isNew };
}

function updateCardUI(card, rec){
  card.querySelector('[data-lastVisited]').textContent = formatDT(rec?.lastVisited);
  card.querySelector('[data-lastChecked]').textContent = formatDT(rec?.lastChecked);
  card.querySelector('[data-etag]').textContent = rec?.etag || '—';
  card.querySelector('[data-lastmod]').textContent = rec?.lastMod || '—';
  card.querySelector('[data-fp]').textContent = rec?.fingerprint ? rec.fingerprint.slice(0,12)+'…' : '—';
  card.querySelector('[data-source]').textContent = rec?.source || '—';
  const flags = computeFlags(rec);
  setBadges(card, flags);
}

async function checkOne(url, card){
  // 更新チェックは無効化しているので何もしません（互換のために残置）
  const rec = await getRecord(url);
  updateCardUI(card, rec);
}

async function render(){
  const grid = document.getElementById('linkGrid');
  grid.innerHTML = '';

  for (const c of CHAINS){
    const card = cardTemplate(c);
    grid.appendChild(card);

    const rec = await getRecord(c.url);
    updateCardUI(card, rec);

    // 開く（最終アクセスのみ記録）
    {
      const el = card.querySelector('[data-open]');
      if (el) el.addEventListener('click', async ()=>{
        const prev = await getRecord(c.url) || { url: c.url };
        const now = Date.now();
        const merged = { ...prev, url: c.url, lastVisited: now };
        await putRecord(merged);
        updateCardUI(card, merged);
      });
    }

    // （更新チェックは無効化）存在しても何もしない
    {
      const el = card.querySelector('[data-check]');
      if (el) el.addEventListener('click', async (e)=>{
        e.preventDefault();
        await checkOne(c.url, card);
      });
    }

    // 詳細
    {
      const el = card.querySelector('[data-debug]');
      if (el) el.addEventListener('click', async ()=>{
        if(c.text != "") {
          alert(c.text);
        }
        else {
          const r = await getRecord(c.url);
          alert(JSON.stringify(r, null, 2));
        }
      });
    }

    // ソース表示（手動確認用）
    {
      const el = card.querySelector('[data-viewsrc]');
      if (el) el.addEventListener('click', ()=>{
        try { window.open('view-source:' + c.url, '_blank'); }
        catch(e){ alert('view-source: はブラウザによってはブロックされます。Chrome/Edgeでお試しください。'); }
      });
    }
  }
}

async function recheckAll(){
  // 更新チェックを廃止したため実質 no-op（互換のために残置）
  const cards = [...document.querySelectorAll('.card')];
  for (const card of cards){
    const url = card.querySelector('.url')?.textContent?.trim();
    if (!url) continue;
    await checkOne(url, card);
  }
}

// === 初期化 ================================================================
(async function init(){
  try{
    db = await openDB();
    const diag = document.getElementById('diag');
    if(diag){ diag.textContent = db ? '保存方式: IndexedDB' : '保存方式: localStorage（フォールバック）'; }
    await render();
  }catch(e){
    // 最低限でもカードは描画する
    const diag = document.getElementById('diag');
    if(diag){ diag.textContent = '保存方式: localStorage（フォールバック）'; }
    db = null;
    await render();
  }

  // btn-recheck はモードにより存在しないことがあるため防御的に
  {
    const btnRe = document.getElementById('btn-recheck');
    if (btnRe) btnRe.addEventListener('click', recheckAll);
  }
  {
    const btnReset = document.getElementById('btn-reset');
    if (btnReset) btnReset.addEventListener('click', async ()=>{
      if(confirm('保存した記録を全て削除します。よろしいですか？')){
        await clearAll();
        await render();
      }
    });
  }
})();
</script>
</body>
</html>
















































